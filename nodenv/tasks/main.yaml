- name: git clone nodenv
  git:
    repo: https://github.com/nodenv/nodenv.git
    dest: "{{ dirs.nodenv.dest }}"
    depth: 1
- name: compile nodenv
  shell: src/configure && make -C src
  args:
    chdir: "{{ dirs.nodenv.dest }}"
- name: mkdir ~/.nodenv/plugins
  file:
    path: "{{ dirs.nodenv.plugins }}"
    state: directory
- name: git clone node-build
  git:
    repo: https://github.com/nodenv/node-build.git
    dest: "{{ dirs.node_build }}"
    depth: 1
- name: nodenv install
  shell: |
    PATH="$HOME/.nodenv/bin:$PATH"
    eval "$(nodenv init -)"
    nodenv install {{ node_version }}
    nodenv global {{ node_version }}
  args:
    creates: "{{ dirs.nodenv.dest }}/versions/{{ node_version }}"
  when: node_version is defined
- name: install yarn
  npm:
    name: "{{ item.name }}"
    executable: "{{ dirs.nodenv.dest }}/versions/{{ node_version }}/bin/npm"
    global: yes
    state: latest
    version: "{{ item.version }}"
  with_items:
    - "{{ npm.packages }}"
  when: node_version is defined
